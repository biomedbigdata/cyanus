---
title: "Differential Marker Expression Analysis"
author: "Arend Lis, Bernett Judith, Manz Quirin "
date: "12.01.2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)
library(data.table)
library(CATALYST)
library(flowCore)
library(ggplot2)
library(SingleCellExperiment)
library(readxl)
library(diffcyt)
library(RColorBrewer)
library(grid)
library(futile.logger)
set.seed(1234)

sapply(list.files("../functions", full.names = TRUE), source)
source("../SigEMD/sigEMD.R")
```

# Upload Data, Preprocessing and Clustering
If you don't want to perform the reduction of the data (selection of patients, sampling of cells), clustering, and the visualization methods, you can simply skip those steps and load the data here. You can then directly pass to the comparison of the differential marker expression analysis methods.
```{r}
path_to_rds <- "/nfs/home/students/l.arend/data/platelets/sceSampledCellsClustered.rds"
sce <- readRDS(path_to_rds)
```

Otherwise, upload data here.
```{r, data, eval=FALSE}
path_to_rds <- "../data/platelets/sce_transformed.rds"
sce <- readRDS(path_to_rds)
```

Make patient selection based on preprocessing plots and clustering results
```{r, selection, eval=FALSE}
sce <- makePatientSelection(sce, deselected_patients = c("RPS 124", "RPS 108", "RPS 096", "RPS 149", "RPS 099"))
```

Sample data to 4 patients receiving dual treatment and 4 patients receiving triple treatment
```{r, samplingPatients, eval=FALSE}
ei <- metadata(sce)$experiment_info
dual <- unique(ei[ei$dual_triple == "dual",]$patient_id)
triple <- unique(ei[ei$dual_triple == "triple",]$patient_id)

set.seed(1234)
sampled_duals <- as.character(dual[sample(length(dual), 4, replace=FALSE)])
set.seed(1234)
sampled_triples <- as.character(triple[sample(length(triple), 4, replace=FALSE)])

sampled_patients <- c(sampled_triples, sampled_duals)
sampled_patients

sce <- filterSCE(sce, patient_id %in% sampled_patients)
```

Sample data to n cells for each sample
```{r, samplingEvents, eval=FALSE}
n <- 10000

ei <- metadata(sce)$experiment_info
sample_ids <- ei$sample_id
coldata <- data.table()

coldata <- colData(sce)
rownames(coldata) <- seq(1:nrow(coldata))

sampled_indices <- c() 
for (id in sample_ids){
  dt <- coldata[coldata$sample_id == id,]
  indices <- rownames(dt)
  set.seed(1234)
  sample <- as.numeric(indices[sample(length(indices), n, replace=FALSE)])
  sampled_indices <- c(sampled_indices, sample)
}

sampled_indices <- sort(sampled_indices)

sce <- sce[,sampled_indices]

# metadata experiment_info does not update when subselecting
ei$n_cells <- rep(n, nrow(ei))
metadata(sce)$experiment_info <- ei
```

Cluster the filtered SingleCellExperiment and run dimensionality reduction methods:
```{r, eval=FALSE}

sce <- clusterSCE(sce) 

DR_methods <- c("UMAP", "TSNE", "PCA", "MDS", "DiffusionMap", "Isomap")
for( method in DR_methods ){
  print(method)
  sce <- runCatalystDR(sce, method, cells_chosen = 100, feature_chosen = "type", assay_chosen = "exprs", scale = T, k = 3)
}

#saveRDS(sce,"../data/platelets/sceSampledCells.rds")

```


# Comparison of Differential Marker Expression Analysis Methods

### Register Parallel Backend

```{r}
library(BiocParallel)
# Set the parameters and register the back-end to be used
param <- MulticoreParam(workers = 22)
register(param)
```

### set none markers to state to check them too

```{r}
none_markers <- rownames(sce)[marker_classes(sce) == "none"]

rowData(sce)$marker_class[marker_classes(sce) == "none"] <- "state"
```

## Dual Activated vs. Dual Baseline
Let's try all possible methods on the dual samples:
```{r}
# subsett SingleCellExperiment for dual patients
sce_dual <- filterSCE(sce, dual_triple == "dual")

res_dual <- suppressMessages(runDS_old(sce = sce_dual,
      condition = "activated_baseline",
      random_effect = "patient_id",
      de_methods = c("limma","LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 100,
      parallel = TRUE))


# significant markers found by all methods:

createVennDiagramOld(res_dual)
```

Let's try to permute the labels (activated and baseline) and check the results.

```{r}
sce_dual_sampled <- sce_dual

ei <- metadata(sce_dual_sampled)$experiment_info

# sample A and B 
set.seed(1234)
condition <- sample(ei$activated_baseline)

# edit activated_baseline condition in experiment_info
ei$activated_baseline <- condition
metadata(sce_dual_sampled)$experiment_info <- ei

# edit activated_baseline in colData (not corrected in sample name)
coldata_condition <- rep(condition, times=ei$n_cells)
colData(sce_dual_sampled)$activated_baseline <- as.factor(coldata_condition)

res_dual_sampled <- suppressMessages(runDS_old(sce = sce_dual_sampled,
      condition = "activated_baseline",
      random_effect = "patient_id",
      de_methods = c("limma","LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 100,
      parallel = TRUE))

createVennDiagramOld(res_dual_sampled)

```

Something is fishy with SigEMD and DEsingle. 

Let's permute labels per sample opposed to per event (what SigEMD does internally):

```{r}
res_perm_samples <- suppressMessages(SigEMD(sce_dual, "all", "activated_baseline", Hur_gene = rownames(sce_dual), nperm = 100, parallel = TRUE, permute_samples = TRUE))
res_perm_samples$overall <- data.table::rbindlist(lapply(res_perm_samples, function(x) x$emdall))
res_dual$SigEMD <- res_perm_samples

createVennDiagramOld(res_dual)
```


Show heatmaps of the different methods:
```{r}
CATALYST::plotDiffHeatmap(sce_dual, rowData(res_dual$limma$res), all=TRUE, k="all")

CATALYST::plotDiffHeatmap(sce_dual, rowData(res_dual$LMM$res), all=TRUE, k="all")

CATALYST::plotDiffHeatmap(sce_dual, res_dual$SigEMD$overall, all=TRUE, k="all")

CATALYST::plotDiffHeatmap(sce_dual, res_dual$DEsingle, all=TRUE, k="all")

```


Let's check the difference between running SigEMD with or without logistic regression:

```{r}
timed1 <- system.time(emd_result <- SigEMD(sce_dual, "all", "activated_baseline", nperm=1, parallel=TRUE, permute_samples = TRUE))
print(timed1)

emd_result <- emd_result$all
source("../SigEMD/plot_sig.R")
#lapply(state_markers(sce_dual), function(marker) plot_emd_density_sig(emd_result, marker))
```


```{r}
# now check if what happens if we skip the logistic regression
timed <- system.time(emd_result_allHur <- SigEMD(sce_dual, "all", "activated_baseline", Hur_gene=rownames(sce_dual), nperm=1, parallel=TRUE, permute_samples = TRUE))
print(timed)
emd_result_allHur <- emd_result_allHur$all
lapply(emd_result$nonHur_gene, function(marker) plot_emd_density_sig(emd_result, marker))
```


```{r}
# How much did the zeros contribute?
xtable(emd_result$emdall[marker_id %in% emd_result$nonHur_gene, .(marker_id, emd)][emd_result_allHur$emdall[marker_id %in% emd_result$nonHur_gene, .(marker_id, emd_with_zeros = emd)], on = "marker_id"][order(-emd)])
#print(emd_result_allHur$emdall[marker_id %in% emd_result$nonHur_gene, .(emd_no_zeros = emd)])
```

<!-- Interesting about DEsingle: permuting per event gives less DE markers. -->

<!-- ```{r, eval=FALSE} -->
<!-- library(DEsingle) -->

<!-- sce_desingle <- sce_dual_ab -->
<!-- new_counts <- assay(sce_desingle, "exprs") -->
<!-- new_counts <- (abs(new_counts)+new_counts)/2 -->
<!-- assay(sce_desingle, "counts") <- new_counts -->

<!-- group <- colData(sce_dual_ab)[["activated_baseline"]] -->

<!-- results <- DEsingle::DEsingle(sce_desingle, group, parallel = TRUE) -->

<!-- results.classified <- DEtype(results = results, threshold = 0.05) -->
<!-- results.classified -->

<!-- set.seed(1234) -->
<!-- results_permuted <- DEsingle::DEsingle(sce_desingle, sample(group), parallel = TRUE) -->

<!-- results_permuted.classified <- DEtype(results = results_permuted, threshold = 0.05) -->
<!-- results_permuted.classified -->
<!-- ``` -->


## Triple Activated vs. Triple Baseline
Let's try all possible methods on the triple samples:
```{r}
sce_triple <- filterSCE(sce, dual_triple == "triple")

res_triple <- suppressMessages(runDS_old(sce = sce_triple,
      condition = "activated_baseline",
      random_effect = "patient_id",
      de_methods = c("limma", "LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 200,
      permute_samples = TRUE,
      parallel = TRUE))

# significant markers found by all methods:
createVennDiagramOld(res_triple)
```


## Dual Activated vs. Triple Activated
Let's try all possible methods on the A samples:
```{r}
sce_a <- filterSCE(sce, activated_baseline == "A")

res_a <- suppressMessages(runDS_old(sce = sce_a,
      condition = "dual_triple",
      de_methods = c("limma", "LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 200,
      permute_samples = TRUE,
      parallel = TRUE))

# Significant markers found by all methods:
createVennDiagramOld(res_a)
```


## Dual Baseline vs. Triple Basleline
Let's try all possible methods on the B samples:
```{r}
sce_b <- filterSCE(sce, activated_baseline == "B")

res_b <- suppressMessages(runDS_old(sce = sce_b,
      condition = "dual_triple",
      de_methods = c("limma", "LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 200,
      permute_samples = TRUE,
      parallel = TRUE))

# Significant markers found by all methods:
createVennDiagramOld(res_b)
```
```
