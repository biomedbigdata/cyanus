---
title: "Differential Marker Expression Analysis"
author: "Arend Lis, Bernett Judith, Manz Quirin "
date: "12.01.2021"
output: :
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)
library(CATALYST)
library(flowCore)
library(ggplot2)
library(SingleCellExperiment)
library(data.table)
library(readxl)
library(diffcyt)
library(RColorBrewer)
library(grid)
library(futile.logger)
library(VennDiagram)
set.seed(1234)

source("shiny_functions.R")
source("../server/clusterFun.R")
```

# Load Data

```{r data}
path_to_rds <- "../data/platelets/sce_transformed.rds"
sce <- readRDS(path_to_rds)
sce <- filterSCE(sce, patient_id %in% c("RPS 098", "RPS 136", "RPS 099", "RPS 127", "RPS 154", "RPS 139", "RPS 137", "RPS 103"))
sce <- clusterSCE(sce)
sce <- mergeClusters(sce, k = "meta20", id = "all", table = data.frame(old_cluster = seq_len(20), new_cluster = "all"))
```

Let's try out SigEMD:

1. Check activate vs. baseline for dual 

```{r, eval=FALSE}
library(BiocParallel)
# Set the parameters and register the back-end to be used
param <- MulticoreParam(workers = 22)
register(param)

timed1 <- system.time(emd_result <- SigEMD(sce[, colData(sce)$dual_triple == "dual"], "all", "activated_baseline", nperm=100, parallel=TRUE))
#     user   system  elapsed 
# 4346.330 1598.441 2182.108 
print(timed1)

emd_result <- emd_result$all
source("../SigEMD/plot_sig.R")
lapply(emd_result$nonHur_gene, function(marker) plot_emd_density_sig(emd_result, marker))
```


```{r, eval=FALSE}
# now check if what happens if we skip the logistic regression
timed <- system.time(emd_result_allHur <- SigEMD(sce[, colData(sce)$dual_triple == "dual"], "all", "activated_baseline", Hur_gene=rownames(sce), nperm=100, parallel=TRUE, verbose = TRUE))
print(timed)
emd_result_allHur <- emd_result_allHur$all
lapply(state_markers(sce), function(marker) plot_emd_density_sig(emd_result, marker))
```


```{r, eval=FALSE}
# How much was contributed from the zeros?
print(emd_result$emdall[emd_result$nonHur_gene, ])
print(emd_result_allHur$emdall[emd_result$nonHur_gene, ])
```

Let's try out DEsingle:

```{r, eval=FALSE}
library(zinbwave)

group <- colData(sce)[["dual_triple"]]

# Detecting the DE genes in parallelization with 22 cores
results <- DEsingle(counts = sce, group = group, parallel = TRUE, BPPARAM = param)

# Dividing the DE genes into 3 categories at threshold of FDR < 0.05
results.classified <- DEtype(results = results, threshold = 0.05)
```





# Set up of contrast matrix, formula and design matrix
```{r set_up}
ei <- metadata(sce)$experiment_info
contrast <- createContrast(c(0, 1))
formula <- createFormula(ei, cols_fixed = "condition")
formula2 <- createFormula(ei, cols_fixed = "condition", cols_random = "patient_id")
design <- createDesignMatrix(ei, cols_design = c("condition"))

clustering_to_use = "meta12"

```

# Differential States

## Performance of limma
```{r limma}
out_limma <- diffcyt(
  d_input = sce,
  design = design,
  contrast = contrast,
  analysis_type = "DS",
  method_DS = "diffcyt-DS-limma",
  clustering_to_use = clustering_to_use
)

plotDiffHeatmap(sce,
                rowData(out_limma$res),
                fdr = 0.05,
                sort_by = "padj",
                col_anno = "condition")

topTable(out_limma$res)
```

## Performance of Linear Mixed Models
```{r LMM}
out_LMM <- diffcyt(
  d_input = sce,
  formula = formula,
  contrast = contrast,
  analysis_type = "DS",
  method_DS = "diffcyt-DS-LMM",
  clustering_to_use = clustering_to_use
)

plotDiffHeatmap(sce,
                rowData(out_LMM$res),
                fdr = 0.05,
                sort_by = "padj",
                col_anno = "condition")

topTable(out_LMM$res)
```
## Significant markers found by all methods

```{r  DA_venn}
sign_limma <- data.frame(rowData(out_limma$res))
sign_LMM <- data.frame(rowData(out_LMM$res))
sign_limma <- sign_limma[c("cluster_id","marker_id","p_val","p_adj")]
sign_LMM <- sign_LMM[c("cluster_id","marker_id","p_val","p_adj")]

sign_limma$significant <- sign_limma$p_adj < 0.05
sign_LMM$significant <- sign_LMM$p_adj < 0.05


limma <- unlist(subset(sign_limma, significant==TRUE, select=c(marker_id, cluster_id), use.names=FALSE))
LMM <- unlist(subset(sign_LMM, significant==TRUE, select=c(marker_id, cluster_id), use.names=FALSE))
  
venn <- venn.diagram(
  x = list(limma,LMM),
  filename = "plots/diff_marker_expr_DS.png",
  category.names = c("limma","LMM"),
  image.type = "png",
  cex = 2.0,
  fontfamily = "sans",
  col=c("#99CC99", '#CC3333'),
  fill = c(alpha("#99CC99",0.3), alpha('#CC3333',0.3)),
  cat.cex = 1.8,
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  main = paste("Limma vs. LMM"),
  main.fontface = "bold",
  main.fontfamily = "sans",
  main.cex = 2.0,
  sub = paste("P-adjusted < 0.05"),
  sub.cex=1.5 ,
  sub.fontfamily="sans"
  )

```


# Differential Abundances

## Performance of edgeR
```{r edgeR}
out_edgeR <- diffcyt(
  d_input = sce,
  design = design,
  contrast = contrast,
  analysis_type = "DA",
  method_DA = "diffcyt-DA-edgeR",
  clustering_to_use = clustering_to_use
)

plotDiffHeatmap(sce,
                rowData(out_edgeR$res),
                fdr = 0.05,
                sort_by = "padj",
                col_anno = "condition")

topTable(out_edgeR$res)
```

## Performance of edgeR
```{r voom}
out_voom <- diffcyt(
  d_input = sce,
  design = design,
  contrast = contrast,
  analysis_type = "DA",
  method_DA = "diffcyt-DA-voom",
  clustering_to_use = clustering_to_use
)

plotDiffHeatmap(sce,
                rowData(out_voom$res),
                fdr = 0.05,
                sort_by = "padj",
                col_anno = "condition")

topTable(out_voom$res)
```


## Performance of Generalized Linear Mixed Models
```{r GLMM}
out_GLMM <- diffcyt(
  d_input = sce,
  formula = formula2,  # attention -> other formula as edgeR
  contrast = contrast,
  analysis_type = "DA",
  method_DA = "diffcyt-DA-GLMM",
  clustering_to_use = clustering_to_use
)

plotDiffHeatmap(sce,
                rowData(out_GLMM$res),
                fdr = 0.05,
                sort_by = "padj",
                col_anno = "condition")

topTable(out_GLMM$res)
````
## Significant markers found by all methods

```{r  DA_venn}
sign_edgeR <- data.frame(rowData(out_edgeR$res))
sign_voom <- data.frame(rowData(out_voom$res))
sign_GLMM <- data.frame(rowData(out_GLMM$res))

sign_edgeR <- sign_edgeR[c("cluster_id","p_val","p_adj")]
sign_voom <- sign_voom[c("cluster_id","p_val","p_adj")]
sign_GLMM <- sign_GLMM[c("cluster_id","p_val","p_adj")]

sign_edgeR$significant <- sign_edgeR$p_adj < 0.05
sign_voom$significant <- sign_voom$p_adj < 0.05
sign_GLMM$significant <- sign_GLMM$p_adj < 0.05


edgeR <- unlist(subset(sign_edgeR, significant==TRUE, select=c(cluster_id), use.names=FALSE))
voom <- unlist(subset(sign_voom, significant==TRUE, select=c(cluster_id), use.names=FALSE))
GLMM <- unlist(subset(sign_GLMM, significant==TRUE, select=c(cluster_id), use.names=FALSE))
  
venn <- venn.diagram(
  x = list(edgeR,GLMM,voom),
  filename = "plots/diff_marker_expr_DA.png",
  category.names = c("edgeR","GLMM","Voom"),
  image.type = "png",
  cex = 2.0,
  fontfamily = "sans",
  col=c("#99CC99", '#CC3333','#3366CC'),
  fill = c(alpha("#99CC99",0.3), alpha('#CC3333',0.3),alpha('#3366CC',0.3)),
  cat.cex = 1.8,
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  main = paste("EdgeR vs. GLMM vs. Voom"),
  main.fontface = "bold",
  main.fontfamily = "sans",
  main.cex = 2.0,
  sub = paste("P-adjusted < 0.05"),
  sub.cex=1.5 ,
  sub.fontfamily="sans"
  )

````



