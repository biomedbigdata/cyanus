---
title: "Differential Marker Expression Analysis"
author: "Arend Lis, Bernett Judith, Manz Quirin "
date: "12.01.2021"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)
library(CATALYST)
library(flowCore)
library(ggplot2)
library(SingleCellExperiment)
library(data.table)
library(readxl)
library(diffcyt)
library(RColorBrewer)
library(grid)
library(futile.logger)
library(VennDiagram)
set.seed(1234)

source("shiny_functions.R")
source("../server/clusterFun.R")
```

# Upload Data, Preprocessing and Clustering
If you don't want to perform the reduction of the data (selection of patients, sampling of cells), clustering, and the visualization methods, you can simply skip those steps and load the data here. You can then directly pass to the comparison of the differential marker expression analysis methods.
```{r}
path_to_rds <- "../data/platelets/sceSampledCellsClustered.rds"
sce <- readRDS(path_to_rds)
```

Otherwise, upload data here.
```{r, data}
path_to_rds <- "../data/platelets/sce_transformed.rds"
sce <- readRDS(path_to_rds)
```

Make patient selection based on preprocessing plots and clustering results
```{r, selection}
sce <- makePatientSelection(sce, deselected_patients = c("RPS 124", "RPS 108", "RPS 96", "RPS 149"))
```

Sample data to 4 patients receiving dual treatment and 4 patients receiving triple treatment
```{r, samplingPatients, eval=FALSE}
ei <- metadata(sce)$experiment_info
dual <- unique(ei[ei$dual_triple == "dual",]$patient_id)
triple <- unique(ei[ei$dual_triple == "triple",]$patient_id)

set.seed(1234)
sampled_duals <- as.character(dual[sample(length(dual), 4, replace=FALSE)])
set.seed(1234)
sampled_triples <- as.character(triple[sample(length(triple), 4, replace=FALSE)])

sampled_patients <- c(sampled_triples, sampled_duals)
sampled_patients

# sampled patients should be "RPS 136" "RPS 099" "RPS 127" "RPS 098" "RPS 154" "RPS 137" "RPS 139" "RPS 103"

sce <- filterSCE(sce, patient_id %in% sampled_patients)
```

Sample data to n cells for each sample
```{r, samplingEvents}
n <- 10000

ei <- metadata(sce)$experiment_info
sample_ids <- ei$sample_id
coldata <- data.table()

coldata <- colData(sce)
rownames(coldata) <- seq(1:nrow(coldata))

sampled_indices <- c() 
for (id in sample_ids){
  dt <- coldata[coldata$sample_id == id,]
  indices <- rownames(dt)
  set.seed(1234)
  sample <- as.numeric(indices[sample(length(indices), n, replace=FALSE)])
  sampled_indices <- c(sampled_indices, sample)
}

sampled_indices <- sort(sampled_indices)

sce <- sce[,sampled_indices]

# metadata experiment_info does not update when subselecting
ei$n_cells <- rep(n, nrow(ei))
metadata(sce)$experiment_info <- ei
```

Cluster the filtered SingleCellExperiment and run dimensionality reduction methods:
```{r}
sce <- clusterSCE(sce) 

DR_methods <- c("UMAP", "TSNE", "PCA", "MDS", "DiffusionMap", "Isomap")
for( method in DR_methods ){
  print(method)
  sce <- runDimRed(sce, method, cells_chosen = 100, feature_chosen = "type", assay_chosen = "exprs", scale = T, k = 3)
}

#saveRDS(sce,"../data/platelets/sceSampledCells.rds")

```


# Comparison of Differential Marker Expression Analysis Methods

## Dual Activated vs. Dual Baseline
Let's try all possible methods on the dual samples:
```{r}
res <- runDS(sce = sce[, colData(sce)$dual_triple == "dual"],
      condition = "activated_baseline",
      de_methods = c("limma", "LMM", "SigEMD", "DEsingle"),
      k = "meta2",
      features = "all",
      nperm = 10,
      parallel = TRUE)

for (method in res){
  print(method)
}
```

Let's try SigEMD:
```{r, eval=FALSE}
library(BiocParallel)
# Set the parameters and register the back-end to be used
param <- MulticoreParam(workers = 4)
register(param)

timed1 <- system.time(emd_result <- SigEMD(sce_dual_ab, "all", "activated_baseline", nperm=100, parallel=TRUE))
#     user   system  elapsed 
# 4346.330 1598.441 2182.108 
print(timed1)

emd_result <- emd_result$all
source("../SigEMD/plot_sig.R")
lapply(emd_result$nonHur_gene, function(marker) plot_emd_density_sig(emd_result, marker))
```


```{r, eval=FALSE}
# now check if what happens if we skip the logistic regression
timed <- system.time(emd_result_allHur <- SigEMD(sce_dual_ab, "all", "activated_baseline", Hur_gene=rownames(sce_dual_ab), nperm=100, parallel=TRUE))
print(timed)
emd_result_allHur <- emd_result_allHur$all
lapply(state_markers(sce_dual_ab), function(marker) plot_emd_density_sig(emd_result, marker))
```


```{r, eval=FALSE}
# How much was contributed from the zeros?
print(emd_result$emdall[emd_result$nonHur_gene, ])
print(emd_result_allHur$emdall[emd_result$nonHur_gene, ])
```

Let's try out DEsingle:
```{r, eval=FALSE}
library(DEsingle)

sce_desingle <- sce_dual_ab
new_counts <- assay(sce_desingle, "exprs")
new_counts <- (abs(new_counts)+new_counts)/2
assay(sce_desingle, "counts") <- new_counts

group <- colData(sce_dual_ab)[["activated_baseline"]]

results <- DEsingle::DEsingle(sce_desingle, group, parallel = TRUE)

results.classified <- DEtype(results = results, threshold = 0.05)
results.classified

results_permuted <- DEsingle::DEsingle(sce_desingle, sample(group), parallel = TRUE)

results_permuted.classified <- DEtype(results = results_permuted, threshold = 0.05)
results_permuted.classified
```

Significant markers found by all methods:
```{r}
venn <- createVennDiagram(res)

```

```{r}
sce_small <- readRDS("../data/platelets_small/sce.rds")
is_marker <- rowData(sce_small)$marker_class %in% c("type","state")
id_all_markers <- (rowData(sce_small)$marker_class %in% c("type","state"))[is_marker] # type and state (but not none)
allsamples <- unique(colData(sce_small)$sample_id)
dual_ab <- grep("dual",allsamples,value=TRUE)
sce_small_dual_ab <- filterSCE(sce_small, sample_id %in% dual_ab) # not using makeSampleSelection dual_ab are the including samples
parameters <-  prepDiffExp(sce = sce_small_dual_ab, contrastVars = c("activated_baseline"), colsFixed = c("activated_baseline"), colsRandom=c("patient_id"), method = "diffcyt-DS-LMM")
LMM_dual_ab <- diffcyt::diffcyt(d_input = sce_small_dual_ab,
                 formula = parameters[["formula"]],
                 contrast = parameters[["contrast"]],
                 analysis_type = "DS",
                 method_DS = "diffcyt-DS-LMM",
                 clustering_to_use = "all",
                 markers_to_test = id_all_markers)
data.table::as.data.table(diffcyt::topTable(LMM_dual_ab$res, all=TRUE))
sign_LMM <- data.frame(rowData(LMM_dual_ab$res))[c("cluster_id","marker_id","p_val","p_adj")]
sign_LMM$significant <- sign_LMM$p_adj < 0.05
LMM <- unlist(subset(sign_LMM, significant==TRUE, select=c(marker_id), use.names=FALSE))
CATALYST::plotDiffHeatmap(x = sce_small_dual_ab,
                          y = rowData(LMM_dual_ab$res), 
                          all = T)
```

## Triple Activated vs. Triple Baseline

## Dual Activated vs. Triple Activated

## Dual Baseline vs. Triple Basleline



