---
title: "Differential Marker Expression Analysis"
author: "Arend Lis, Bernett Judith, Manz Quirin "
date: "12.01.2021"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)
library(data.table)
library(CATALYST)
library(flowCore)
library(ggplot2)
library(SingleCellExperiment)
library(readxl)
library(diffcyt)
library(RColorBrewer)
library(grid)
library(futile.logger)
set.seed(1234)

source("shiny_functions.R")
source("../server/clusterFun.R")
```

# Upload Data, Preprocessing and Clustering
If you don't want to perform the reduction of the data (selection of patients, sampling of cells), clustering, and the visualization methods, you can simply skip those steps and load the data here. You can then directly pass to the comparison of the differential marker expression analysis methods.
```{r}
path_to_rds <- "../data/platelets/sceSampledCellsClustered.rds"
sce <- readRDS(path_to_rds)
```

Otherwise, upload data here.
```{r, data, eval=FALSE}
path_to_rds <- "../data/platelets/sce_transformed.rds"
sce <- readRDS(path_to_rds)
```

Make patient selection based on preprocessing plots and clustering results
```{r, selection, eval=FALSE}
sce <- makePatientSelection(sce, deselected_patients = c("RPS 124", "RPS 108", "RPS 96", "RPS 149"))
```

Sample data to 4 patients receiving dual treatment and 4 patients receiving triple treatment
```{r, samplingPatients, eval=FALSE}
ei <- metadata(sce)$experiment_info
dual <- unique(ei[ei$dual_triple == "dual",]$patient_id)
triple <- unique(ei[ei$dual_triple == "triple",]$patient_id)

set.seed(1234)
sampled_duals <- as.character(dual[sample(length(dual), 4, replace=FALSE)])
set.seed(1234)
sampled_triples <- as.character(triple[sample(length(triple), 4, replace=FALSE)])

sampled_patients <- c(sampled_triples, sampled_duals)
sampled_patients

# sampled patients should be "RPS 136" "RPS 099" "RPS 127" "RPS 098" "RPS 154" "RPS 137" "RPS 139" "RPS 103"

sce <- filterSCE(sce, patient_id %in% sampled_patients)
```

Sample data to n cells for each sample
```{r, samplingEvents, eval=FALSE}
n <- 10000

ei <- metadata(sce)$experiment_info
sample_ids <- ei$sample_id
coldata <- data.table()

coldata <- colData(sce)
rownames(coldata) <- seq(1:nrow(coldata))

sampled_indices <- c() 
for (id in sample_ids){
  dt <- coldata[coldata$sample_id == id,]
  indices <- rownames(dt)
  set.seed(1234)
  sample <- as.numeric(indices[sample(length(indices), n, replace=FALSE)])
  sampled_indices <- c(sampled_indices, sample)
}

sampled_indices <- sort(sampled_indices)

sce <- sce[,sampled_indices]

# metadata experiment_info does not update when subselecting
ei$n_cells <- rep(n, nrow(ei))
metadata(sce)$experiment_info <- ei
```

Cluster the filtered SingleCellExperiment and run dimensionality reduction methods:
```{r, eval=FALSE}
sce <- clusterSCE(sce) 

DR_methods <- c("UMAP", "TSNE", "PCA", "MDS", "DiffusionMap", "Isomap")
for( method in DR_methods ){
  print(method)
  sce <- runDimRed(sce, method, cells_chosen = 100, feature_chosen = "type", assay_chosen = "exprs", scale = T, k = 3)
}

#saveRDS(sce,"../data/platelets/sceSampledCells.rds")

```


# Comparison of Differential Marker Expression Analysis Methods

### Register Parallel Backend

```{r}
library(BiocParallel)
# Set the parameters and register the back-end to be used
param <- MulticoreParam(workers = 22)
register(param)
```

## Dual Activated vs. Dual Baseline
Let's try all possible methods on the dual samples:
```{r}
# subsett SingleCellExperiment for dual patients
sce_dual <- filterSCE(sce, dual_triple == "dual")

res_dual <- runDS(sce = sce_dual,
      condition = "activated_baseline",
      de_methods = c("limma","LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 100,
      parallel = TRUE)


# significant markers found by all methods:

createVennDiagram(res_dual)
```


Let's try to permute the labels (activated and baseline) and check the results.

```{r}
sce_dual_sampled <- sce_dual

ei <- metadata(sce_dual_sampled)$experiment_info

# sample A and B 
set.seed(1234)
condition <- sample(ei$activated_baseline)

# edit activated_baseline condition in experiment_info
ei$activated_baseline <- condition
metadata(sce_dual_sampled)$experiment_info <- ei

# edit activated_baseline in colData (not corrected in sample name)
coldata_condition <- rep(condition, times=ei$n_cells)
colData(sce_dual_sampled)$activated_baseline <- as.factor(coldata_condition)

res_dual_sampled <- runDS(sce = sce_dual_sampled,
      condition = "activated_baseline",
      de_methods = c("limma","LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 100,
      parallel = TRUE)

createVennDiagram(res_dual_sampled)

```

Something is fishy with SigEMD and DEsingle. 

Let's permute labels per sample opposed to per event (what SigEMD does internally):

First, Let's have a look at the actual SigEMD results again:

```{r}
res_dual_real <- res_dual$SigEMD$all$emdall[, .(real_emd = emd, marker_id)]
setkey(res_dual_real, marker_id)
res_dual_real
```


```{r}
sce_dual_sampled <- sce_dual

nperm <- 100
used_permutations <- list()
used_permutations[[nperm + 1]] <- metadata(sce_dual_sampled)$experiment_info$activated_baseline
all_results <- list()

for (i in 1:nperm){
ei <- metadata(sce_dual_sampled)$experiment_info

# sample A and B
#set.seed(i)
repeat {
  condition <- sample(ei$activated_baseline)
  if (Position(function(x) identical(x, condition), used_permutations, nomatch = 0) == 0) {
    used_permutations[[i]] <- condition
    break
  }
}

# edit activated_baseline condition in experiment_info
ei$activated_baseline <- condition
metadata(sce_dual_sampled)$experiment_info <- ei

# edit activated_baseline in colData (not corrected in sample name)
coldata_condition <- rep(condition, times=ei$n_cells)
colData(sce_dual_sampled)$activated_baseline <- as.factor(coldata_condition)

all_results[[i]] <- SigEMD(sce = sce_dual_sampled,
      k = "all",
      condition = "activated_baseline",
      Hur_gene=rownames(sce_dual_sampled),
      nperm = 1,
      parallel = TRUE)

}
all_perms <- rbindlist(lapply(all_results, function(x) x$all$emd), idcol = "permutation")
all_perms[, p_val := NULL]
all_perms[, p_adj := NULL]
setkey(all_perms, marker_id)

res_agg <- all_perms[res_dual_real][, .(p_val = (sum(emd <= real_emd) + 1)/(nperm + 1)), by = marker_id]
res_agg[, p_adj := p.adjust(p_val, "BH")]
res_agg[order(p_adj)]
```



Let's check the difference between running SigEMD with or without logistic regression:

```{r, eval=FALSE}
timed1 <- system.time(emd_result <- SigEMD(sce_dual_ab, "all", "activated_baseline", nperm=100, parallel=TRUE))
#     user   system  elapsed 
# 4346.330 1598.441 2182.108 
print(timed1)

emd_result <- emd_result$all
source("../SigEMD/plot_sig.R")
lapply(res_sampled$SigEMD$all$nonHur_gene, function(marker) plot_emd_density_sig(res_sampled$SigEMD$all, marker))
```


```{r, eval=FALSE}
# now check if what happens if we skip the logistic regression
timed <- system.time(emd_result_allHur <- SigEMD(sce_dual_ab, "all", "activated_baseline", Hur_gene=rownames(sce_dual_ab), nperm=100, parallel=TRUE))
print(timed)
emd_result_allHur <- emd_result_allHur$all
lapply(state_markers(sce_dual_ab), function(marker) plot_emd_density_sig(emd_result, marker))
```


```{r, eval=FALSE}
# How much did the zeros contributed?
print(emd_result$emdall[emd_result$nonHur_gene, ])
print(emd_result_allHur$emdall[emd_result$nonHur_gene, ])
```

<!-- Interesting about DEsingle: permuting per event gives less DE markers. -->

<!-- ```{r, eval=FALSE} -->
<!-- library(DEsingle) -->

<!-- sce_desingle <- sce_dual_ab -->
<!-- new_counts <- assay(sce_desingle, "exprs") -->
<!-- new_counts <- (abs(new_counts)+new_counts)/2 -->
<!-- assay(sce_desingle, "counts") <- new_counts -->

<!-- group <- colData(sce_dual_ab)[["activated_baseline"]] -->

<!-- results <- DEsingle::DEsingle(sce_desingle, group, parallel = TRUE) -->

<!-- results.classified <- DEtype(results = results, threshold = 0.05) -->
<!-- results.classified -->

<!-- set.seed(1234) -->
<!-- results_permuted <- DEsingle::DEsingle(sce_desingle, sample(group), parallel = TRUE) -->

<!-- results_permuted.classified <- DEtype(results = results_permuted, threshold = 0.05) -->
<!-- results_permuted.classified -->
<!-- ``` -->


## Triple Activated vs. Triple Baseline
Let's try all possible methods on the triple samples:
```{r}
sce_triple <- filterSCE(sce, dual_triple == "triple")

res_triple <- runDS(sce = sce_triple,
      condition = "activated_baseline",
      de_methods = c("limma", "LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 100,
      parallel = TRUE)

# significant markers found by all methods:
createVennDiagram(res_triple)
```


## Dual Activated vs. Triple Activated
Let's try all possible methods on the A samples:
```{r}
sce_a <- filterSCE(sce, activated_baseline == "A")

res_a <- runDS(sce = sce_a,
      condition = "dual_triple",
      de_methods = c("limma", "LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 100,
      parallel = TRUE)

# Significant markers found by all methods:
createVennDiagram(res_a)
```


## Dual Baseline vs. Triple Basleline
Let's try all possible methods on the B samples:
```{r}
sce_b <- filterSCE(sce, activated_baseline == "B")

res_b <- runDS(sce = sce_b,
      condition = "dual_triple",
      de_methods = c("limma", "LMM", "SigEMD", "DEsingle"),
      k = "all",
      features = "all",
      nperm = 100,
      parallel = TRUE)

# Significant markers found by all methods:
createVennDiagram(res_b)
```
```


