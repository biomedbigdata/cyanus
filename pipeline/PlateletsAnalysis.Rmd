---
title: "Differential Marker Expression Analysis of Platelet Data"
author: "Arend Lis, Bernett Judith, Manz Quirin "
date: "1/18/2021"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)
library(CATALYST)
library(flowCore)
library(ggplot2)
library(SingleCellExperiment)
library(data.table)
library(readxl)
library(diffcyt)
library(RColorBrewer)
library(grid)
library(futile.logger)
library(VennDiagram)
library(stringr)
set.seed(1234)

source("shiny_functions.R")
source("../server/clusterFun.R")
```

Data from human platelets of patients with chronic coronary syndrome undergoing different therapy: dual antiplatelet therapy versus triple antiplatelet therapy, before and after platelet activation with 10Âµm TRAP. There are files of 7 patients with triple therapy and 12 patients with dual therapy (each in two condtions).

# Data Upload and Data Preprocessing
Fcs files, as well as metadata and a panel file are given for this dataset and uploaded in this section. You just have to specify the path to your files. The Single Cell Experiment is then created using the prepData function of CATALYST. The function prepData can directly transform the marker intesities using arcsinh (inverse hyerpoblic sine) to make the distributions more symmetrix and to map them to a comparable range of expression. Recommended values for the cofactor parameter are 5 for mass cytometry (CyTOF) or 150 for fluorescence flow cytometry

```{r,eval=FALSE}
path <- "/Users/lisiarend/Desktop/Uni/Master/SysBioMed/CyTOF/extdata/HumanPlatelets"
#path <- "/Users/judith_bernett/Desktop/Bioinfo/SystemsBioMedicine/systems_biomedicine_spill_applied_fcs_files/"
cofactor <- 5
exp <-list.files(path,pattern = "\\.fcs$",full.names = T)#[1:14]
names <- list.files(path,pattern = "*.fcs")#[1:14]
samples <-sapply(names, function(x) {
    strsplit(x, split = ".fcs")[[1]]
  })
patients <-sapply(names, function(x) {
    str_sub(strsplit(x, split = "_")[[1]][1], end = -2)
  })
a_b <- sapply(names, function(x) {
    str_sub(strsplit(x, split = "_")[[1]][1], start = 8)
  })
dual_triple <-
  sapply(names, function(x) {
    strsplit(strsplit(x, split = "_")[[1]][2], split = ".fcs")[[1]][1]
  })
metadata <- data.table(
  "file_name" = names,
  "sample_id" = samples,
  "patient_id" = patients,
  "activated_baseline" = a_b,
  "dual_triple" = dual_triple
)
panel <-read_excel(paste0(path,"panel_platelets.xlsx"))
sce <-
  prepData(
    exp,
    panel,
    metadata,
    transform = TRUE,
    cofactor = cofactor,
    md_cols = list(
      file = "file_name",
      id = "sample_id",
      factors = c("activated_baseline", "dual_triple","patient_id")
    )
  )
```

Otherwise, you can load the "sce_transformed.rds" file which already contains the transformed SingleCellExperiment.

```{r}
path_to_rds <- "/nfs/home/students/l.arend/data/platelets/sce_transformed.rds"
sce <- readRDS(path_to_rds)

#or load already clustered SingleCellExperiment
#path_to_rds <- "../data/platelets/sceFilteredClustered.rds"
#sce <- readRDS(path_to_rds)
```


The shiny app also includes some simple visualization plots to verify whether the data represents what we expect, for example, whether samples that are replicates of one condition are more similar and are distinct from samples from another condition. Depending on the situation, one can then consider removing problematic markers or samples from further analysis.

```{r, fig.width=12, fig.height=8}
CATALYST::plotCounts(
    sce,
    group_by = "patient_id", # possible inputs: names(colData(sce))
    color_by = "dual_triple", # possible inputs: names(colData(sce))
    prop = FALSE # TRUE for stacked relative abundances, FALSE for total cell counts
  )

CATALYST::pbMDS(
      sce,
      label_by = "patient_id", 
      color_by = "dual_triple",
      features = "type", # possible inputs: unique(rowData(sce)$marker_class) or NULL (to use all features)
      assay = "exprs", # possible inputs: assayNames(sce)
    )

CATALYST::plotNRS(
      sce,
      color_by = "activated_baseline",
      features = "state",
      assay = "exprs"
    )

CATALYST::plotExprs(
      sce,
      color_by = "activated_baseline",
      features = "type",
      assay = "exprs"
    )

CATALYST::plotExprs(
      sce,
      color_by = "activated_baseline",
      features = "state",
      assay = "exprs"
    )

CATALYST::plotExprs(
      sce,
      color_by = "dual_triple",
      features = NULL,
      assay = "exprs"
    )


CATALYST::plotExprHeatmap(
      sce,
      features = NULL,
      assay = "exprs"
    )
```

These plots can then be used to select patients as well as samples and filter the Single Cell Experiment. As one can see, the number of cells in patient RPS124 is notably lower than in the other patients. Additionally, the MDS plot shows that patients RPS108 and RPS124 are separated from the others. A deeper look into these patients is taken after the clustering.

Furthermore, the state markers show strong differences between activated and baseline platelets. Comparing dual treatment versus triple treatment, no big difference in marker expression is noticeable.

# Clustering
Clustering is performed using Flowsom on the type markers.
```{r}
sce <- clusterSCE(sce)
```

Let's have a look at the clusters:
```{r}
plotly::ggplotly(delta_area(sce))

CATALYST::plotAbundances(sce, "meta12", group_by = "dual_triple")

CATALYST::plotAbundances(sce, "meta12", by = "cluster_id", group_by = "dual_triple")
```

As we can see above, some patients have odd clusters. Further investigation might be necessary to uncover the reasons for that. For now we will exclude the patients from the analysis. Hence, we will repeat the clustering step
```{r}
sce <- makePatientSelection(sce = sce, deselected_patients = c("RPS 108", "RPS 096", "RPS 149", "RPS 124"))
sce <- clusterSCE(sce)
```

```{r}
plotly::ggplotly(delta_area(sce))

CATALYST::plotAbundances(sce, "meta12", group_by = "dual_triple")

CATALYST::plotAbundances(sce, "meta12", by = "cluster_id", group_by = "patient_id", shape_by = "dual_triple")

invisible(plotStarsCustom(sce, backgroundValues = cluster_codes(sce)[["meta12"]]))
```

```{r}
CATALYST::plotClusterExprs(sce, "meta12")

CATALYST::plotFreqHeatmap(sce, "meta12")
```

Now, we can visualize the different clusters, but first we have to run the methods


# Data Visualization
You can now run various dimensionality reduction methods on your data. The options are (parameter dr_chosen): 
<ul>
<li>"UMAP"</li>
<li>"TSNE"</li>
<li>"PCA"</li>
<li>"MDS"</li> 
<li>"DiffusionMap" and </li>
<li>"Isomap"</li>
</ul>
Other run options are:
<ul>
<li> cells_chosen: number of cells to sample from.  </li>
<li> feature_chosen: markers or marker class. We recommend using "type" </li>
<li>assay_chosen: "counts" or "exprs". We recommend using "exprs" </li> 
<li> scale: TRUE or FALSE. We recommend using TRUE </li>
<li> k: Isomap-specific parameter. Specifies the number of neighbours for the graph constructed by isomap </li>

Let's run all methods so that we can compare them later:

```{r}
DR_methods <- c("UMAP", "TSNE", "PCA", "MDS", "DiffusionMap", "Isomap")

for( method in DR_methods ){
  print(method)
  sce <- runDimRed(sce, method, cells_chosen = 100, feature_chosen = "type", assay_chosen = "exprs", scale = T, k = 3)
}
```

You can now simply visualize the dimensionality reduction by using the CATALYST function plotDR. For now, let's color by activated_baseline and facet by dual_triple. Later, we can also color by cluster.

```{r}
for( method in DR_methods ){
  g <- CATALYST::plotDR(sce, dr = method, color_by = "dual_triple", facet_by = "activated_baseline")
  print(g)
}
```

We can also colour by marker expression. Before, we saw that CD36, CD47 and PAR1 were the top three markers: 

```{r}
for( method in DR_methods ){
  g <- CATALYST::plotDR(sce, dr = method, color_by = c("CD36", "CD47"), facet_by = "activated_baseline", assay = "exprs", scale = T)
  print(g)
}
```


After clustering and visualization, we can move to the differential expression analysis.

# Differential Expression Analysis
Before performing the differential marker expression analysis, the median marker expressions are plotted.
```{r,fig.with=12, fig.height=8}
CATALYST::plotPbExprs(sce, k = "all", features = NULL , color_by = "activated_baseline", 
              facet_by = "cluster_id", shape_by = "dual_triple")
```
This plot shows the median marker expression of state and type markers colored by activated and baseline conditions. The state marker CD62P shows the biggest difference in activated and baseline platelets. The activated platelets show a higher median expression than the baseline samples. The same applies for marker CD63. This state marker is also more expressed in activated platelets than in baseline platelets. 

Now we are going to check the median marker expressions for the condition dual therapy and triple therapy.
```{r,fig.with=12, fig.height=8}
CATALYST::plotPbExprs(sce, k = "all", features = NULL, color_by = "dual_triple", 
              facet_by = "cluster_id", shape_by = "activated_baseline")
```
This plots shows no significant difference in median marker expression for dual and triple therapies.

In the next step, 4 major comparisons are made. The dual activated conditions is compared to the dual baseline condition. This comparison is also performed for triple therapy (triple activated vs. triple baseline). In addition, dual activated is compared to triple activated and dual baseline is compared to triple baseline.

## Dual Activated vs. Dual Baseline
```{r}
# subsett SingleCellExperiment for dual patients
tmp <- filterSCE(sce, dual_triple == "dual")

res <- runDS(sce = tmp,
      condition = "activated_baseline",
      de_methods = c("limma"),
      k = "all",
      features = "all",
      )
```

Now, we can visualize that: 
```{r,fig.with=12, fig.height=8}
CATALYST::plotDiffHeatmap(tmp, rowData(res$limma$res), all = T)
```

## Triple Activated vs. Triple Baseline
Let's try all possible methods on the triple samples:
```{r}
tmp <- filterSCE(sce, dual_triple == "triple")

res <- runDS(sce = tmp,
      condition = "activated_baseline",
      de_methods = c("limma"),
      k = "all",
      features = "all",
      )

```
Now, we can visualize that: 
```{r,fig.with=12, fig.height=8}
CATALYST::plotDiffHeatmap(tmp, rowData(res$limma$res), all = T)
```


## Dual Activated vs. Triple Activated
Let's try all possible methods on the A samples:
```{r}
tmp <- filterSCE(sce, activated_baseline == "A")

res <- runDS(sce = tmp,
      condition = "dual_triple",
      de_methods = c("limma"),
      k = "all",
      features = "all",
      )

```

Now, we can visualize that: 
```{r,fig.with=12, fig.height=8}
CATALYST::plotDiffHeatmap(tmp, rowData(res$limma$res), all = T)
```

## Dual Baseline vs. Triple Basleline
Let's try all possible methods on the B samples:
```{r}
tmp <- filterSCE(sce, activated_baseline == "B")

res <- runDS(sce = tmp,
      condition = "dual_triple",
      de_methods = c("limma"),
      k = "all",
      features = "all",
      )

```

Now, we can visualize that: 
```{r,fig.with=12, fig.height=8}
CATALYST::plotDiffHeatmap(tmp, rowData(res$limma$res), all = T)
```



