---
title: "Differential Marker Expression Analysis of Platelet Data"
author: "Arend Lis, Bernett Judith, Manz Quirin "
date: "1/18/2021"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(CATALYST)
library(flowCore)
library(ggplot2)
library(SingleCellExperiment)
library(data.table)
library(readxl)
library(diffcyt)
library(RColorBrewer)
library(grid)
library(futile.logger)
library(VennDiagram)
library(stringr)

source("shiny_functions.R")
```

Data from human platelets of patients with chronic coronary syndrome undergoing different therapy: dual antiplatelet therapy versus triple antiplatelet therapy, before and after platelet activation with 10Âµm TRAP. There are files of 7 patients with triple therapy and 12 patients with dual therapy (each in two condtions)."

# Data Upload and Data Preprocessing
Fcs files, as well as metadata and a panel file are given for this dataset and uploaded in this section. You just have to specify the path to your files. The Single Cell Experiment is then created using the prepData function of CATALYST. The function prepData can directly transform the marker intesities using arcsinh (inverse hyerpoblic sine) to make the distributions more symmetrix and to map them to a comparable range of expression. Recommended values for the cofactor parameter are 5 for mass cytometry (CyTOF) or 150 for fluorescence flow cytometry

```{r,eval=FALSE}
path <- "../extdata/HumanPlatelets"
cofactor <- 5

full_paths <- list.files(path, "\\.fcs$", full.names = T)
filename_sans_path <- sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(full_paths))
metadata <- split(unlist(strsplit(filename_sans_path, "_(?!.*_)", perl=TRUE)), c("patient_id", "dual_triple"))
nchar_id <- nchar(metadata$patient_id)
metadata$activated_baseline <- substring(metadata$patient_id, nchar_id)
metadata$patient_id <- substr(metadata$patient_id, 1, nchar_id - 1)
metadata <- lapply(metadata, as.factor)

metadata$file_name <- basename(full_paths)
metadata$sample_id <- filename_sans_path

panel <-read_excel(file.path(path,"panel_platelets.xlsx"))

sce <-
  prepData(
    exp,
    panel,
    as.data.frame(metadata),
    transform = TRUE,
    cofactor = cofactor,
    md_cols = list(
      file = "file_name",
      id = "sample_id",
      factors = c("activated_baseline", "dual_triple","patient_id")
    )
  )
```

Otherwise, you can load the "sce_transformed.rds" file which already contains the transformed SingleCellExperiment.
```{r}
path_to_rds <- "../data/platelets/sce_transformed.rds"
sce <- readRDS(path_to_rds)
```


The shiny app also includes some simple visualization plots to verify whether the data represents what we expect, for example, whether samples that are replicates of one condition are more similar and are distinct from samples from another condition. Depending on the situation, one can then consider removing problematic markers or samples from further analysis.

```{r}
CATALYST::plotCounts(
    sce,
    group_by = "patient_id", # possible inputs: names(colData(sce))
    color_by = "dual_triple", # possible inputs: names(colData(sce))
    prop = FALSE # TRUE for stacked relative abundances, FALSE for total cell counts
  )

CATALYST::pbMDS(
      sce,
      label_by = "patient_id", 
      color_by = "dual_triple",
      features = "type", # possible inputs: unique(rowData(sce)$marker_class) or NULL (to use all features)
      assay = "exprs", # possible inputs: assayNames(sce)
    )

CATALYST::plotNRS(
      sce,
      color_by = "patient_id",
      features = "type",
      assay = "exprs"
    )

CATALYST::plotExprs(
      sce,
      color_by = "dual_triple",
      features = "type",
      assay = "exprs"
    )
```
These plots can then be used to select patients as well as samples and filter the Single Cell Experiment. As one can see, the number of cells in patient RPS124 is notably lower than in the other patients.

```{r}
# Patients that should not be included
sce <- makePatientSelection(sce = sce, deselected_patients = c("RPS 124"))

# You can also select sampels that should not be included
# sce <- makeSampleSelection(sce = sce, deselected_samples = c())
```

# Data Visualization

You can now run various dimensionality reduction methods on your data. The options are (parameter dr_chosen): 
<ul>
<li>"UMAP"</li>
<li>"TSNE"</li>
<li>"PCA"</li>
<li>"MDS"</li> 
<li>"DiffusionMap" and </li>
<li>"Isomap"</li>
</ul>
Other run options are:
<ul>
<li> cells_chosen: number of cells to sample from.  </li>
<li> feature_chosen: markers or marker class. We recommend using "type" </li>
<li>assay_chosen: "counts" or "exprs". We recommend using "exprs" </li> 
<li> scale: TRUE or FALSE. We recommend using TRUE </li>
<li> k: Isomap-specific parameter. Specifies the number of neighbours for the graph constructed by isomap </li>

Let's run all methods so that we can compare them later:
```{r}
for( method in c("UMAP", "TSNE", "PCA", "MDS", "DiffusionMap", "Isomap") ){
  print(method)
  sce <- runDimRed(sce, method, cells_chosen = 100, feature_chosen = "type", assay_chosen = "exprs", scale = T, k = 3)
}
```
You can now simply visualize the dimensionality reduction by using the CATALYST function plotDR. For now, let's color by activated_baseline and facet by dual_triple. Later, we can also color by cluster.
```{r}
for( method in c("UMAP", "TSNE", "PCA", "MDS", "DiffusionMap", "Isomap") ){
  g <- CATALYST::plotDR(sce, dr = method, color_by = "dual_triple", facet_by = "activated_baseline")
  print(g)
}
```


We can also colour by marker expression. Before, we saw that CD36, CD47 and PAR1 were the top three markers: 
```{r}
for( method in c("UMAP", "TSNE", "PCA", "MDS", "DiffusionMap", "Isomap") ){
  g <- CATALYST::plotDR(sce, dr = method, color_by = c("CD36", "CD47"), facet_by = "activated_baseline", assay = "exprs", scale = T)
  print(g)
}
```

# Clustering

```{r}
sce <- cluster(sce)
```

Let's have a look at the clusters:

```{r}
plotly::ggplotly(delta_area(sce))

CATALYST::plotAbundances(sce, "meta12", group_by = "dual_triple")

CATALYST::plotAbundances(sce, "meta12", by = "cluster_id", group_by = "dual_triple")
```

As we can see above, some patients have odd clusters. 
Further investigation might be necessary to uncover the reasons for that.
For now we will exclude the patients from the analysis.
Hence, we will repeat the clustering step

```{r}
sce <- makePatientSelection(sce = sce, deselected_patients = c("RPS 108", "RPS 124", "RPS 096"))
sce <- cluster(sce)
```

```{r}
plotly::ggplotly(delta_area(sce))

CATALYST::plotAbundances(sce, "meta10", group_by = "dual_triple")

CATALYST::plotAbundances(sce, "meta10", by = "cluster_id", group_by = "dual_triple")
```

```{r}
CATALYST::plotClusterExprs(sce, "meta10")

CATALYST::plotFreqHeatmap(sce, "meta10")
```


Now, we can visualize the different clusters: 
```{r}
for (method in c("UMAP", "TSNE", "PCA", "MDS", "DiffusionMap", "Isomap")) {
  g <- CATALYST::plotDR(sce, dr = method, color_by = "meta10")
  print(g)
}
```

Now that we've done the clustering, we can do the differential expression analysis

# Differential Expression Analysis

Depending on the method you want to run ("diffcyt-DA-edgeR", "diffcyt-DA-voom","diffcyt-DA-GLMM", "diffcyt-DS-limma", "diffcyt-DS-LMM"), you either have to specify columns to include in the design matrix or for linear models fixed and random effects. For both, you have to specify the condition you want to analyse because this will be converted to a contrast matrix:

```{r}
parameters <- prepDiffExp(sce, contrastVars = c("dual_triple", "activated_baseline"), colsDesign = c("dual_triple", "activated_baseline"), method = "diffcyt-DA-edgeR")
out <- diffcyt::diffcyt(d_input = sce,
                 design = parameters[["design"]],
                 contrast = parameters[["contrast"]],
                 analysis_type = "DA",
                 method_DA = "diffcyt-DA-edgeR",
                 clustering_to_use = "meta10",
                 trend_method = "locfit",
                 normalize = T)

```

Now, we can visualize that: 
```{r}
CATALYST::plotPbExprs(sce, k = "meta10", features = "state", color_by = "activated_baseline", 
              facet_by = "cluster_id", shape_by = "dual_triple")
CATALYST::plotPbExprs(sce, features = "state", facet_by = "antigen", color_by = "activated_baseline", shape_by = "dual_triple")
CATALYST::plotDiffHeatmap(sce, rowData(out$res), all = T)
```

